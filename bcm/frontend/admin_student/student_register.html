<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Registration Portal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
     <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f7f6;
      color: #333;
    }

    .form-section {
      max-width: 700px;
      margin: 50px auto;
      background-color: rgba(255, 255, 255, 0.95);
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      backdrop-filter: blur(5px);
    }

    .form-section h2 {
      text-align: center;
      margin-bottom: 30px;
      color: #2c3e50;
      font-size: 2em;
    }

    .step-indicator {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px;
    }

    .step {
      flex: 1;
      text-align: center;
      font-weight: bold;
      color: #bbb;
      position: relative;
    }

    .step::before {
      content: attr(data-step);
      display: inline-block;
      background-color: #ccc;
      color: white;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      line-height: 30px;
      margin-bottom: 5px;
    }

    .step.active {
      color: #007bff;
    }

    .step.active::before {
      background-color: #007bff;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #2c3e50;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px 15px;
      font-size: 1em;
      border: 1px solid #000;
      border-radius: 8px;
      box-sizing: border-box;
      transition: border 0.3s ease;
    }

    .form-group input::placeholder,
    .form-group textarea::placeholder {
      color: #888;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      border-color: #007bff;
      outline: none;
    }

    .form-group input[type="file"] {
      padding: 8px;
    }

    .form-navigation button.card-button,
    .form-navigation button.next-button,
    .form-navigation button.prev-button {
      display: block;
      width: fit-content;
      padding: 12px 25px;
      font-size: 1em;
      font-weight: bold;
      color: white;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
    }

    .form-navigation button.card-button,
    .form-navigation button.next-button {
      background-color: #28a745;
    }
    
    .form-navigation button.card-button:hover,
    .form-navigation button.next-button:hover {
      background-color: #218838;
      transform: translateY(-2px);
      box-shadow: 0 7px 20px rgba(40, 167, 69, 0.3);
    }

    .form-navigation button.prev-button {
      background-color: #6c757d;
    }

    .form-navigation button.prev-button:hover {
      background-color: #5a6268;
      transform: translateY(-2px);
      box-shadow: 0 7px 20px rgba(108, 117, 125, 0.3);
    }

    .form-navigation a.button-link {
    display: inline-block;
    text-decoration: none;
}

#successMessage {
    text-align: center;
    background: #fff;
    padding: 3rem;
    border-radius: 15px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    width: 100%;
    max-width: 700px;
    margin: 50px auto;
}

#successMessage h3 {
    color: #28a745;
    font-size: 2em;
    margin-bottom: 1rem;
}

    .form-navigation {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
    }

    .review-summary-item {
      margin-bottom: 10px;
      padding: 10px;
      background-color: #e9ecef;
      border-radius: 5px;
    }
    
    .review-summary-item strong {
      display: inline-block;
      min-width: 150px;
    }
    .back-btn {
    position: absolute;
    top: 2rem;
    left: 2rem;
    background: none;
    border: none;
    font-size: 1.8rem;
    cursor: pointer;
    color: #555;
    transition: color 0.2s;
    padding: 0;
    line-height: 1;
    width: auto; /* Makes button fit its content */
}
.back-btn:hover {
    color: #000;
}
  </style>

</head>
<body>

<div class="form-container">
    <button class="back-btn" onclick="window.history.back()">&#8592;</button>
    <form id="studentForm" novalidate>
        
        <div class="form-section" id="step1">
            <h2>Student Registration</h2>
            <div class="step-indicator">
                <div class="step active" data-step="1">Personal</div>
                <div class="step" data-step="2">Parent</div>
                <div class="step" data-step="3">Documents</div>
                <div class="step" data-step="4">Academics</div>
                <div class="step" data-step="5">Review</div>
            </div>
            <h4>Step 1: Personal Information</h4>
            <div class="form-group">
                <label for="name">Name (as per Aadhar)</label>
                <input type="text" id="name" name="name" placeholder="Enter your full name" required />
            </div>
            <div class="form-group">
                <label for="sspId">SSP ID (11 digits)</label>
                <input type="number" id="sspId" name="sspId" placeholder="Enter your SSP ID" required minlength="11" maxlength="11" />
            </div>
            <div class="form-group">
                <label for="dob">Date of Birth</label>
                <input type="date" id="dob" name="dob" required />
            </div>
            <div class="form-group">
                <label for="phone">Phone Number (10 digits)</label>
                <input type="tel" id="phone" name="phone" pattern="[0-9]{10}" placeholder="Enter your phone number" required />
            </div>
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email" placeholder="Enter your email address" required />
            </div>
            <div class="form-group">
                <label for="address">Address (as per Aadhar)</label>
                <textarea id="address" name="address" rows="3" placeholder="Enter your address" required></textarea>
            </div>
            <div class="form-group">
                <label for="photo">Upload Recent Photo (JPG/PNG, < 200KB)</label>
                <input type="file" id="photo" name="photo" accept="image/png, image/jpeg" required />
            </div>
            <div class="form-navigation">
                <div></div> <button type="button" class="next-button" id="step1Next">Next Step</button>
            </div>
        </div>

        <div class="form-section" id="step2" style="display: none;">
            <h2>Student Registration</h2>
            <div class="step-indicator">
                 <div class="step completed" data-step="1">Personal</div>
                 <div class="step active" data-step="2">Parent</div>
                 <div class="step" data-step="3">Documents</div>
                 <div class="step" data-step="4">Academics</div>
                 <div class="step" data-step="5">Review</div>
            </div>
            <h4>Step 2: Parent Information</h4>
            <div class="form-group">
                <label for="fatherName">Father's Name</label>
                <input type="text" id="fatherName" name="fatherName" placeholder="Enter father's name" required />
            </div>
            <div class="form-group">
                <label for="motherName">Mother's Name</label>
                <input type="text" id="motherName" name="motherName" placeholder="Enter mother's name" required />
            </div>
            <div class="form-group">
                <label for="parentPhone">Parent Phone Number (10 digits)</label>
                <input type="tel" id="parentPhone" name="parentPhone" placeholder="Enter parent phone number" pattern="[0-9]{10}" required />
            </div>
            <div class="form-group">
                <label for="parentEmail">Parent Email (optional)</label>
                <input type="email" id="parentEmail" name="parentEmail" placeholder="Enter parent email if exists" />
            </div>
            <div class="form-group">
                <label for="parentAddress">Parent Address</label>
                <textarea id="parentAddress" name="parentAddress" rows="3" placeholder="Enter parent address" required></textarea>
            </div>
            <div class="form-navigation">
                <button type="button" class="prev-button" id="step2Prev">Previous</button>
                <button type="button" class="next-button" id="step2Next">Next Step</button>
            </div>
        </div>

        <div class="form-section" id="step3" style="display: none;">
            <h2>Student Registration</h2>
            <div class="step-indicator">
                <div class="step completed" data-step="1">Personal</div>
                <div class="step completed" data-step="2">Parent</div>
                <div class="step active" data-step="3">Documents</div>
                <div class="step" data-step="4">Academics</div>
                <div class="step" data-step="5">Review</div>
            </div>
            <h4>Step 3: Document Uploads</h4>
            <div class="form-group">
                <label for="aadharNumber">Aadhar Number (12 digits)</label>
                <input type="text" id="aadharNumber" name="aadharNumber" placeholder="Enter your Aadhar number" pattern="[0-9]{12}" required />
            </div>
            <div class="form-group">
                <label for="aadharCard">Upload Aadhar Card (PDF, < 200KB)</label>
                <input type="file" id="aadharCard" name="aadharCard" accept="application/pdf" required />
            </div>
            <div class="form-group">
                <label for="casteNumber">Caste Certificate Number</label>
                <input type="text" id="casteNumber" name="casteNumber" placeholder="Enter caste certificate number" required />
            </div>
            <div class="form-group">
                <label for="casteCertificate">Upload Caste Certificate (PDF, < 200KB)</label>
                <input type="file" id="casteCertificate" name="casteCertificate" accept="application/pdf" required />
            </div>
            <div class="form-group">
                <label for="incomeNumber">Income Certificate Number</label>
                <input type="text" id="incomeNumber" name="incomeNumber" placeholder="Enter income certificate number" required />
            </div>
            <div class="form-group">
                <label for="incomeCertificate">Upload Income Certificate (PDF, < 200KB)</label>
                <input type="file" id="incomeCertificate" name="incomeCertificate" accept="application/pdf" required />
            </div>
            <div class="form-group">
                <label for="accountNumber">Bank Account Number</label>
                <input type="text" id="accountNumber" name="accountNumber" placeholder="Enter your account number" required />
            </div>
            <div class="form-group">
                <label for="ifsc">IFSC Code</label>
                <input type="text" id="ifsc" name="ifsc" placeholder="Enter IFSC code" required />
            </div>
            <div class="form-group">
                <label for="passbook">Upload Bank Passbook (PDF, < 200KB)</label>
                <input type="file" id="passbook" name="passbook" accept="application/pdf" required />
            </div>
            <div class="form-navigation">
                <button type="button" class="prev-button" id="step3Prev">Previous</button>
                <button type="button" class="next-button" id="step3Next">Next Step</button>
            </div>
        </div>
        
        <div class="form-section" id="step4" style="display: none;">
            <h2>Student Registration</h2>
            <div class="step-indicator">
                <div class="step completed" data-step="1">Personal</div>
                <div class="step completed" data-step="2">Parent</div>
                <div class="step completed" data-step="3">Documents</div>
                <div class="step active" data-step="4">Academics</div>
                <div class="step" data-step="5">Review</div>
            </div>
            <h4>Step 4: Academic Information</h4>
            <div class="form-group">
                <label for="tenthMarks">Enter your 10th Marks</label>
                <input type="number" id="tenthMarks" name="tenthMarks" placeholder="Enter 10th Marks" required />
            </div>
            <div class="form-group">
                <label for="tenthMarksCard">Upload your 10th Marks Card (PDF, < 200KB)</label>
                <input type="file" id="tenthMarksCard" name="tenthMarksCard" accept="application/pdf" required />
            </div>
            <div class="form-group">
                <label for="studyAfter10th">What did you study after 10th?</label>
                <select id="studyAfter10th" name="studyAfter10th" required>
                    <option value="">-- Select --</option>
                    <option value="PUC">PUC</option>
                    <option value="Diploma">Diploma</option>
                    <option value="ITI">ITI</option>
                </select>
            </div>
            <div id="pucSection" style="display: none;">
                <div class="form-group">
                    <label for="pucMarks">Enter your PUC Marks</label>
                    <input type="number" id="pucMarks" name="pucMarks" placeholder="Enter PUC Marks" />
                </div>
                <div class="form-group">
                    <label for="pucMarksCard">Upload your PUC Marks Card</label>
                    <input type="file" id="pucMarksCard" name="pucMarksCard" accept="application/pdf" />
                </div>
            </div>
            <div id="diplomaSection" style="display: none;">
                <div class="form-group">
                    <label for="diplomaMarks">Enter Last Semester/Year Diploma Marks</label>
                    <input type="number" id="diplomaMarks" name="diplomaMarks" placeholder="Enter Final Marks" />
                </div>
                <div class="form-group">
                    <label for="diplomaMarksCard">Upload Last Semester/Year Diploma Marks Card</label>
                    <input type="file" id="diplomaMarksCard" name="diplomaMarksCard" accept="application/pdf" />
                </div>
            </div>
            <div id="itiSection" style="display: none;">
                <div class="form-group">
                    <label for="itiMarks">Enter your ITI Marks</label>
                    <input type="number" id="itiMarks" name="itiMarks" placeholder="Enter ITI Marks" />
                </div>
                <div class="form-group">
                    <label for="itiMarksCard">Upload your ITI Marks Card</label>
                    <input type="file" id="itiMarksCard" name="itiMarksCard" accept="application/pdf" />
                </div>
            </div>
            <div class="form-group" id="ugPgSelectGroup" style="display: none;">
                <label for="ugPgSelect">Are you currently doing UG or PG?</label>
                <select id="ugPgSelect" name="ugPgSelect">
                    <option value="">-- Select --</option>
                    <option value="UG">UG</option>
                    <option value="PG">PG</option>
                </select>
            </div>
            <div id="ugSection" style="display: none;">
                <div class="form-group">
                    <label for="ugDegree">Select your UG Degree</label>
                    <select id="ugDegree" name="ugDegree">
                        <option value="">-- Select Degree --</option>
                        <option value="B.A">B.A</option><option value="BBA">BBA</option><option value="BCA">BCA</option><option value="B.Com">B.Com</option><option value="B.Sc">B.Sc</option><option value="B.Ed">B.Ed</option><option value="B.Des">B.Des</option><option value="B.Lit">B.Lit</option><option value="LLB">LLB</option><option value="BE">BE</option><option value="B.Tech">B.Tech</option><option value="B.Pharm">B.Pharm</option><option value="B.Arch">B.Arch</option><option value="B.Sc (Agri)">B.Sc (Agri)</option><option value="B.Sc (Nursing)">B.Sc (Nursing)</option><option value="B.VSc">B.VSc</option><option value="BPT">BPT</option><option value="MBBS">MBBS</option><option value="BAMS">BAMS</option><option value="BHMS">BHMS</option><option value="BUMS">BUMS</option>
                    </select>
                </div>
                <div class="form-group"><label for="ugCollege">Enter your College Name</label><input type="text" id="ugCollege" name="ugCollege" placeholder="College Name" /></div>
                <div class="form-group"><label for="ugCurrentYear">Select Current Year of Study</label><select id="ugCurrentYear" name="ugCurrentYear"><option value="">-- Select Year --</option></select></div>
                <div class="form-group" id="ugSemesterContainer" style="display: none;"><label for="ugSemester">Select Current Semester</label><select id="ugSemester" name="ugSemester"><option value="">-- Select Semester --</option></select></div>
                <div id="ugPreviousMarksSection"></div>
            </div>
            <div id="pgSection" style="display: none;">
                <div class="form-group"><label for="pgLastUgMarks">Enter your Last Semester/Year UG Marks</label><input type="number" id="pgLastUgMarks" name="pgLastUgMarks" placeholder="Enter Marks" /></div>
                <div class="form-group"><label for="pgLastUgMarksCard">Upload your UG Marks Card</label><input type="file" id="pgLastUgMarksCard" name="pgLastUgMarksCard" accept="application/pdf" /></div>
                <div class="form-group">
                    <label for="pgDegree">Select your PG Degree</label>
                    <select id="pgDegree" name="pgDegree">
                        <option value="">-- Select Degree --</option>
                        <option value="MA">MA</option><option value="MSc">MSc</option><option value="MCom">MCom</option><option value="MBA">MBA</option><option value="MCA">MCA</option><option value="MTech">MTech</option><option value="LLM">LLM</option><option value="MD">MD</option><option value="MS">MS</option><option value="M.Ed">M.Ed</option><option value="MPH">MPH</option><option value="MDS">MDS</option>
                    </select>
                </div>
                <div class="form-group"><label for="pgCollege">Enter your College Name</label><input type="text" id="pgCollege" name="pgCollege" placeholder="College Name" /></div>
                <div class="form-group"><label for="pgCurrentYear">Select Current Year of Study</label><select id="pgCurrentYear" name="pgCurrentYear"><option value="">-- Select Year --</option></select></div>
                <div class="form-group" id="pgSemesterContainer" style="display: none;"><label for="pgSemester">Select Current Semester</label><select id="pgSemester" name="pgSemester"><option value="">-- Select Semester --</option></select></div>
                <div id="pgPreviousMarksSection"></div>
            </div>
            <div class="form-navigation">
                <button type="button" class="prev-button" id="step4Prev">Previous</button>
                <button type="button" class="next-button" id="step4Next">Next & Review</button>
            </div>
        </div>

        <div class="form-section" id="step5" style="display: none;">
             <h2>Student Registration</h2>
             <div class="step-indicator">
                <div class="step completed" data-step="1">Personal</div>
                <div class="step completed" data-step="2">Parent</div>
                <div class="step completed" data-step="3">Documents</div>
                <div class="step completed" data-step="4">Academics</div>
                <div class="step active" data-step="5">Review</div>
            </div>
             <div id="reviewSummary"></div>
             <div class="form-navigation">
                 <button type="button" class="prev-button" id="step5Prev">Previous</button>
                 <button type="submit" id="submitFinalForm">Confirm & Submit</button>
             </div>
        </div>
    </form>
    </div>
    

   <!-- Success Message (MOVED OUTSIDE the form container) -->
<div id="successMessage" style="display: none;" class="form-section">
    <h3>Student Registered Successfully!✅</h3>
    <div class="form-navigation" style="justify-content: center; margin-top: 2rem;">
        <a href="#" id="backToForm" class="button-link prev-button">Register a New Student</a>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // --- Element Definitions ---
        const studentForm = document.getElementById("studentForm");
        const formContainer = document.querySelector(".form-container");
        const allStepSections = Array.from(document.querySelectorAll(".form-section"));
        const successMessage = document.getElementById("successMessage");
        const [step1, step2, step3, step4, step5] = allStepSections;

        // --- State Variable ---
        let studentIdToUpdate = null;

        // --- Navigation Buttons ---
        const step1Next = document.getElementById("step1Next");
        const step2Prev = document.getElementById("step2Prev");
        const step2Next = document.getElementById("step2Next");
        const step3Prev = document.getElementById("step3Prev");
        const step3Next = document.getElementById("step3Next");
        const step4Prev = document.getElementById("step4Prev");
        const step4Next = document.getElementById("step4Next");
        const step5Prev = document.getElementById("step5Prev");
        const backToForm = document.getElementById("backToForm");

        // ===================================================================
        // LOGIC TO HANDLE UPDATE MODE
        // ===================================================================
        function populateFormForUpdate() {
            const studentDataString = localStorage.getItem('studentToUpdate');
            if (!studentDataString) return;

            const student = JSON.parse(studentDataString);
            studentIdToUpdate = student._id;

            document.querySelectorAll('h2').forEach(h2 => h2.textContent = 'Update Student Details');
            const submitButton = document.getElementById('submitFinalForm');
            if (submitButton) submitButton.textContent = 'Update Details';

            studentForm.querySelectorAll('input[type="file"]').forEach(input => {
                input.removeAttribute('required');
            });

            for (const key in student) {
                if (typeof student[key] === 'object' && student[key] !== null) continue;
                const field = studentForm.querySelector(`[name="${key}"]`);
                if (field) {
                    if (field.type === 'file') {
                        const existingFileName = student[key];
                        if (existingFileName) {
                            let displayEl = field.parentElement.querySelector('.file-info');
                            if (!displayEl) {
                                displayEl = document.createElement('span');
                                displayEl.className = 'file-info';
                                displayEl.style.cssText = 'margin-left: 10px; font-size: 0.9em; color: #555; font-style: italic;';
                                field.insertAdjacentElement('afterend', displayEl);
                            }
                            displayEl.textContent = `Current: ${existingFileName.split('/').pop()}`;
                        }
                    } else if (field.type === 'date' && student[key]) {
                        field.value = new Date(student[key]).toISOString().split('T')[0];
                    } else {
                        field.value = student[key];
                    }
                }
            }

            const triggerChange = (el) => el.dispatchEvent(new Event('change'));

            if (student.studyAfter10th) {
                studyAfter10th.value = student.studyAfter10th;
                triggerChange(studyAfter10th);
            }

            const details = { ...student.pucDetails, ...student.diplomaDetails, ...student.itiDetails };
            for (const key in details) {
                const field = studentForm.querySelector(`[name="${key}"]`);
                if (field) field.value = details[key];
            }
            
            if (student.currentStudy && student.currentStudy.level) {
                const ugPgSelect = document.getElementById('ugPgSelect');
                ugPgSelect.value = student.currentStudy.level;
                triggerChange(ugPgSelect);

                setTimeout(() => {
                    const level = student.currentStudy.level.toLowerCase();
                    const degreeField = document.getElementById(`${level}Degree`);
                    if (degreeField) {
                        degreeField.value = student.currentStudy.degree || '';
                        triggerChange(degreeField);
                    }
                    const collegeField = document.getElementById(`${level}College`);
                    if (collegeField) collegeField.value = student.currentStudy.college || '';
                    
                    setTimeout(() => {
                        const yearField = document.getElementById(`${level}CurrentYear`);
                        if (yearField) {
                            yearField.value = student.currentStudy.currentYear || '';
                            triggerChange(yearField);
                        }
                    }, 50);
                }, 50);
            }
            
            localStorage.removeItem('studentToUpdate');
        }

        // --- Core Navigation and UI Functions ---
        function showStep(stepElement) {
            allStepSections.forEach(el => { if(el.id !== 'successMessage') el.style.display = "none" });
            if (stepElement) {
                stepElement.style.display = "block";
                updateStepIndicator(stepElement.id);
            }
        }

        function updateStepIndicator(activeId) {
            const activeStepNum = parseInt(activeId.replace("step", ""));
            const indicators = document.querySelectorAll(".step-indicator .step");
            indicators.forEach(el => {
                const stepNum = parseInt(el.getAttribute("data-step"));
                el.classList.remove("active", "completed");
                if (stepNum < activeStepNum) el.classList.add("completed");
                else if (stepNum === activeStepNum) el.classList.add("active");
            });
        }
        
        // --- Validation ---
        function validateStep(stepElement) {
            const inputs = stepElement.querySelectorAll('input[required], select[required], textarea[required]');
            for (const input of inputs) if (!input.checkValidity()) { input.reportValidity(); return false; }
            return true;
        }

        const KB200 = 200 * 1024;
        function validateFile(fileInput, allowedTypes) {
            const file = fileInput.files[0];
            if (!file) {
                if (studentIdToUpdate) return true;
                alert(`Please upload the required file for: ${fileInput.labels[0].textContent}`);
                return false;
            }
            if (allowedTypes && !allowedTypes.includes(file.type)) { alert(`Invalid file type for ${fileInput.labels[0].textContent}.`); return false; }
            if (file.size > KB200) { alert(`File "${file.name}" is too large. Maximum size is 200KB.`); return false; }
            return true;
        }

        // --- Step Navigation Listeners ---
        step1Next.addEventListener("click", () => { if (validateStep(step1)) { if (document.getElementById("phone").value.length !== 10) { alert("Phone number must be exactly 10 digits."); return; } if (document.getElementById("sspId").value.length !== 11) { alert("SSP ID must be exactly 11 digits."); return; } if (!validateFile(document.getElementById("photo"), ["image/jpeg", "image/png"])) return; showStep(step2); } });
        step2Prev.addEventListener("click", () => showStep(step1));
        step2Next.addEventListener("click", () => { if (validateStep(step2)) { if (document.getElementById("parentPhone").value.length !== 10) { alert("Parent phone number must be exactly 10 digits."); return; } if (document.getElementById("parentPhone").value === document.getElementById("phone").value) { alert("Parent's mobile number cannot be the same as the student's."); return; } showStep(step3); } });
        step3Prev.addEventListener("click", () => showStep(step2));
        step3Next.addEventListener("click", () => { if (validateStep(step3)) { if (document.getElementById("aadharNumber").value.length !== 12) { alert("Aadhar number must be exactly 12 digits."); return; } for (const fileId of ["aadharCard", "casteCertificate", "incomeCertificate", "passbook"]) if (!validateFile(document.getElementById(fileId), ["application/pdf"])) return; showStep(step4); } });
        step4Prev.addEventListener("click", () => showStep(step3));
        step5Prev.addEventListener("click", () => showStep(step4));
        backToForm.addEventListener("click", (e) => {
        e.preventDefault(); // Prevents the link from jumping
            localStorage.removeItem('studentToUpdate'); // Clears any old data
            window.location.href = 'student_register.html'; // Goes to the correct page
        });
        step4Next.addEventListener("click", () => { if (validateStep4()) { generateReview(); showStep(step5); } else { alert("Please fill out all required academic fields and upload all necessary documents."); } });

        // --- Final Submission ---
        studentForm.addEventListener("submit", async function (e) { e.preventDefault(); const formData = new FormData(studentForm); let url = "/api/students/register"; let method = "POST"; if (studentIdToUpdate) { url = `/api/students/update/${studentIdToUpdate}`; method = "PUT"; } try { const response = await fetch(url, { method: method, body: formData }); if (response.ok) { formContainer.style.display = "none"; const successH3 = successMessage.querySelector('h3'); successH3.textContent = studentIdToUpdate ? "✅ Student Details Updated Successfully!" : "✅ Student Registered Successfully!"; successMessage.style.display = "block"; } else { const error = await response.json(); alert(`❌ Operation Failed: ${error.message || 'An unknown error occurred.'}`); } } catch (err) { console.error("Submission Error:", err); alert("⚠️ A network error occurred."); } });

        // --- Review Generation ---
        function generateReview() { const reviewSummary = document.getElementById("reviewSummary"); const formData = new FormData(studentForm); let html = "<h4>Please review your details carefully before submitting.</h4>"; for (const [key, value] of formData.entries()) { const element = studentForm.querySelector(`[name="${key}"]`); if (!element) continue; let labelText = element.labels?.[0]?.textContent || key; if (value instanceof File) { if (value.name) html += `<div class="review-summary-item"><strong>${labelText}:</strong> <span>${value.name}</span></div>`; } else if (value) { html += `<div class="review-summary-item"><strong>${labelText}:</strong> <span>${value}</span></div>`; } } reviewSummary.innerHTML = html; }

        // --- Step 4 Dynamic Logic ---
        const studyAfter10th = document.getElementById("studyAfter10th");
        const sections = { puc: document.getElementById("pucSection"), diploma: document.getElementById("diplomaSection"), iti: document.getElementById("itiSection") };
        const ugPgSelectGroup = document.getElementById("ugPgSelectGroup");
        const ugSection = document.getElementById("ugSection"), pgSection = document.getElementById("pgSection");
        const ugDegree = document.getElementById("ugDegree"), ugCurrentYear = document.getElementById("ugCurrentYear"), ugSemester = document.getElementById("ugSemester"), ugPreviousMarksSection = document.getElementById("ugPreviousMarksSection"), ugSemesterContainer = document.getElementById("ugSemesterContainer");
        const pgDegree = document.getElementById("pgDegree"), pgCurrentYear = document.getElementById("pgCurrentYear"), pgSemester = document.getElementById("pgSemester"), pgPreviousMarksSection = document.getElementById("pgPreviousMarksSection"), pgSemesterContainer = document.getElementById("pgSemesterContainer");
        const ugSemBased_3 = new Set(["B.A","BBA","BCA","B.Com","B.Sc","B.Ed","B.Des","B.Lit","LLB"]), ugSemBased_4 = new Set(["BE","B.Tech","B.Pharm","B.Arch","B.Sc (Agri)","B.Sc (Nursing)","B.VSc","BPT"]), ugYearBased_5 = new Set(["MBBS","BAMS","BHMS","BUMS"]);
        const pgSemBased_2 = new Set(["MA","MSc","MCom","MBA","MCA","M.Ed","MPH"]), pgSemBased_3 = new Set(["MTech","LLM"]), pgYearBased_3 = new Set(["MD","MS","MDS"]);
        
        function validateStep4() {if (!document.getElementById("tenthMarks").value || !validateFile(document.getElementById("tenthMarksCard"), ["application/pdf"])) return false; const study = studyAfter10th.value; if (!study) return false; if (study === "PUC") { if (!document.getElementById("pucMarks").value || !validateFile(document.getElementById("pucMarksCard"), ["application/pdf"])) return false; } else if (study === "Diploma") { if (!document.getElementById("diplomaMarks").value || !validateFile(document.getElementById("diplomaMarksCard"), ["application/pdf"])) return false; } else if (study === "ITI") { if (!document.getElementById("itiMarks").value || !validateFile(document.getElementById("itiMarksCard"), ["application/pdf"])) return false; } const ugPg = document.getElementById("ugPgSelect"); if (ugPg.closest('#ugPgSelectGroup').style.display !== "none") {if (!ugPg.value) return false; if (ugPg.value === "UG") {const ugDegree = document.getElementById("ugDegree"); if (!ugDegree.value || !document.getElementById("ugCollege").value || !document.getElementById("ugCurrentYear").value) return false; const degreeType = ugDegree.value, year = parseInt(document.getElementById("ugCurrentYear").value); if (ugSemBased_3.has(degreeType) || ugSemBased_4.has(degreeType)) {const sem = document.getElementById("ugSemester"); if (!sem.value) return false; for (let i = 1; i < parseInt(sem.value); i++) if (!document.getElementById(`ugSem${i}Marks`)?.value || !validateFile(document.getElementById(`ugSem${i}Card`), ["application/pdf"])) return false;} else if (ugYearBased_5.has(degreeType)) {for (let i = 1; i < year; i++) if (!document.getElementById(`ugYear${i}Marks`)?.value || !validateFile(document.getElementById(`ugYear${i}Card`), ["application/pdf"])) return false;}} else if (ugPg.value === "PG") {if (!document.getElementById("pgLastUgMarks").value || !validateFile(document.getElementById("pgLastUgMarksCard"), ["application/pdf"]) || !document.getElementById("pgDegree").value || !document.getElementById("pgCollege").value || !document.getElementById("pgCurrentYear").value) return false; const degreeType = document.getElementById("pgDegree").value, year = parseInt(document.getElementById("pgCurrentYear").value); if (pgSemBased_2.has(degreeType) || pgSemBased_3.has(degreeType)) {const sem = document.getElementById("pgSemester"); if (!sem.value) return false; for (let i = 1; i < parseInt(sem.value); i++) if (!document.getElementById(`pgSem${i}Marks`)?.value || !validateFile(document.getElementById(`pgSem${i}Card`), ["application/pdf"])) return false;} else if (pgYearBased_3.has(degreeType)) {for (let i = 1; i < year; i++) if (!document.getElementById(`pgYear${i}Marks`)?.value || !validateFile(document.getElementById(`pgYear${i}Card`), ["application/pdf"])) return false;}}} return true;}
        
        function clearChildren(el) { el.innerHTML = ''; }
        studyAfter10th.addEventListener("change", function() {const val = this.value; Object.values(sections).forEach(s => { s.style.display = 'none'; s.querySelectorAll('input').forEach(i => i.removeAttribute('required')); }); [ugPgSelectGroup, ugSection, pgSection].forEach(el => el.style.display = 'none'); document.getElementById("ugPgSelect").removeAttribute('required'); if (val) { const sectionKey = val.toLowerCase(); sections[sectionKey].style.display = "block"; sections[sectionKey].querySelectorAll('input').forEach(i => i.setAttribute('required','')); ugPgSelectGroup.style.display = "block"; document.getElementById("ugPgSelect").setAttribute('required',''); } });
        document.getElementById("ugPgSelect").addEventListener("change", function() {const val = this.value; ugSection.style.display = "none"; pgSection.style.display = "none"; ugSection.querySelectorAll('input, select').forEach(el => el.removeAttribute("required")); pgSection.querySelectorAll('input, select').forEach(el => el.removeAttribute("required")); if (val === "UG") { ugSection.style.display = "block"; ['ugDegree', 'ugCollege', 'ugCurrentYear'].forEach(id => document.getElementById(id).setAttribute("required", "")); } else if (val === "PG") { pgSection.style.display = "block"; ['pgLastUgMarks', 'pgLastUgMarksCard', 'pgDegree', 'pgCollege', 'pgCurrentYear'].forEach(id => document.getElementById(id).setAttribute("required", "")); } });
        ugDegree.addEventListener("change", function() {const val = this.value; let years = 0; if (ugSemBased_3.has(val)) years = 3; else if (ugSemBased_4.has(val)) years = 4; else if (ugYearBased_5.has(val)) years = 5; ugCurrentYear.innerHTML = `<option value="">-- Select Year --</option>`; for (let i = 1; i <= years; i++) ugCurrentYear.innerHTML += `<option value="${i}">Year ${i}</option>`; clearChildren(ugPreviousMarksSection); ugSemesterContainer.style.display = "none"; ugSemester.innerHTML = `<option value="">-- Select Semester --</option>`;});
        ugCurrentYear.addEventListener("change", function() {const year = parseInt(this.value), degree = ugDegree.value; clearChildren(ugPreviousMarksSection); ugSemester.innerHTML = `<option value="">-- Select Semester --</option>`; ugSemester.removeAttribute("required"); if (ugSemBased_3.has(degree) || ugSemBased_4.has(degree)) {ugSemesterContainer.style.display = "block"; ugSemester.setAttribute("required", ""); if (year > 0) for (let i = (year - 1) * 2 + 1; i <= year * 2; i++) ugSemester.innerHTML += `<option value="${i}">Semester ${i}</option>`;} else if (ugYearBased_5.has(degree)) {ugSemesterContainer.style.display = "none"; for (let i = 1; i < year; i++) ugPreviousMarksSection.innerHTML += `<div class="form-group"><label>UG Year ${i} Marks</label><input type="number" id="ugYear${i}Marks" name="ugYear${i}Marks" required /><label>Upload UG Year ${i} Marks Card</label><input type="file" id="ugYear${i}Card" name="ugYear${i}Card" accept="application/pdf" required /></div>`;}});
        ugSemester.addEventListener("change", function() {clearChildren(ugPreviousMarksSection); for (let i = 1; i < parseInt(this.value); i++) ugPreviousMarksSection.innerHTML += `<div class="form-group"><label>UG Sem ${i} Marks</label><input type="number" id="ugSem${i}Marks" name="ugSem${i}Marks" required /><label>Upload UG Sem ${i} Marks Card</label><input type="file" id="ugSem${i}Card" name="ugSem${i}Card" accept="application/pdf" required /></div>`;});
        pgDegree.addEventListener("change", function() {const val = this.value; let years = 0; if (pgSemBased_2.has(val)) years = 2; else if (pgSemBased_3.has(val) || pgYearBased_3.has(val)) years = 3; pgCurrentYear.innerHTML = `<option value="">-- Select Year --</option>`; for (let i = 1; i <= years; i++) pgCurrentYear.innerHTML += `<option value="${i}">Year ${i}</option>`; clearChildren(pgPreviousMarksSection); pgSemesterContainer.style.display = "none"; pgSemester.innerHTML = `<option value="">-- Select Semester --</option>`;});
        pgCurrentYear.addEventListener("change", function() {const year = parseInt(this.value), degree = pgDegree.value; clearChildren(pgPreviousMarksSection); pgSemester.innerHTML = `<option value="">-- Select Semester --</option>`; pgSemester.removeAttribute("required"); if (pgSemBased_2.has(degree) || pgSemBased_3.has(degree)) {pgSemesterContainer.style.display = "block"; pgSemester.setAttribute("required", ""); if (year > 0) for (let i = (year - 1) * 2 + 1; i <= year * 2; i++) pgSemester.innerHTML += `<option value="${i}">Semester ${i}</option>`;} else if (pgYearBased_3.has(degree)) {pgSemesterContainer.style.display = "none"; for (let i = 1; i < year; i++) pgPreviousMarksSection.innerHTML += `<div class="form-group"><label>PG Year ${i} Marks</label><input type="number" id="pgYear${i}Marks" name="pgYear${i}Marks" required /><label>Upload PG Year ${i} Marks Card</label><input type="file" id="pgYear${i}Card" name="pgYear${i}Card" accept="application/pdf" required /></div>`;}});
        
        // ===================================================================
        // THIS IS THE CORRECTED PART
        // ===================================================================
        pgSemester.addEventListener("change", function() {
            clearChildren(pgPreviousMarksSection);
            for (let i = 1; i < parseInt(this.value); i++) {
                pgPreviousMarksSection.innerHTML += `
                    <div class="form-group">
                        <label>PG Sem ${i} Marks</label>
                        <input type="number" id="pgSem${i}Marks" name="pgSem${i}Marks" required />
                        <label>Upload PG Sem ${i} Marks Card</label>
                        <input type="file" id="pgSem${i}Card" name="pgSem${i}Card" accept="application/pdf" required />
                    </div>`;
            }
        });

        // --- Initialize Form ---
        populateFormForUpdate(); // Check for update mode FIRST
        showStep(step1); // Then show the first step
    });
</script>


</body>
</html>