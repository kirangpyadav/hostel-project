<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chief - Request Rations</title>
  
   
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; margin: 0; background-color: #f4f6f9; }
        .top-header { background-color: #2c3e50; color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .profile-info { display: flex; align-items: center; gap: 1rem; }
        .profile-pic { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #ffc107; }
        .profile-details h2 { margin: 0; font-size: 1.2em; } .profile-details p { margin: 0; font-size: 0.8em; opacity: 0.8; }
        .header-center h1 { margin: 0; font-size: 1.8em; }
        .back-dashboard-btn { background-color: #007bff; color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 5px; font-weight: 600; cursor: pointer; text-decoration: none;}
        .main-container { padding: 2rem; max-width: 1000px; margin: 2rem auto; }
        .request-container, .history-container { background: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 2rem; }
        .section-title { font-size: 1.8em; font-weight: 700; margin-bottom: 1.5rem; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 0.8rem; font-size: 1rem; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
        .item-selector-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 1.5rem; }
        .category-list { list-style-type: none; padding: 0; margin: 0; border: 1px solid #ddd; border-radius: 8px; height: 250px; overflow-y: auto; }
        .category-list li { padding: 0.8rem; cursor: pointer; transition: background-color 0.2s; border-bottom: 1px solid #eee; }
        .category-list li:last-child { border-bottom: none; }
        .category-list li.active, .category-list li:hover { background-color: #007bff; color: white; font-weight: 500; }
        #itemList { border: 1px solid #ddd; border-radius: 8px; padding: 1rem; height: 250px; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 1rem; }
        .item-card { text-align: center; cursor: pointer; padding: 0.5rem; border-radius: 5px; transition: background-color 0.2s; }
        .item-card:hover { background-color: #f1f1f1; }
        .item-photo { width: 60px; height: 60px; object-fit: cover; border-radius: 5px; }
        .item-card span { font-size: 0.9em; display: block; margin-top: 5px; }
        .request-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .request-table th, .request-table td { padding: 0.8rem; text-align: left; border-bottom: 1px solid #dee2e6; }
        .request-table input[type="number"] { width: 80px; padding: 0.5rem; border-radius: 5px; border: 1px solid #ccc; }
        .remove-btn { color: #dc3545; background: none; border: none; cursor: pointer; font-size: 1.2em; }
        .actions-container { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem; }
        .pdf-btn, .submit-btn { padding: 1rem; font-size: 1.1rem; border-radius: 8px; border:none; cursor: pointer; font-weight: 600; }
        .pdf-btn { background-color: #6c757d; color: white; }
        .submit-btn { background-color: #ffc107; color: #333; }
        .status-badge { display: inline-block; padding: 4px 10px; font-size: 0.8em; font-weight: 700; border-radius: 20px; color: white; }
        .status-Pending { background-color: #ffc107; color: #333; }
        .status-Approved { background-color: #28a745; }
        .status-Rejected { background-color: #dc3545; }
    </style>
</head>
<body>
    <div class="top-header">
        <div class="profile-info">
            <img id="profilePic" src="https://placehold.co/100x100" alt="Profile Photo" class="profile-pic">
            <div class="profile-details">
                <h2 id="chiefName">Loading...</h2>
                <p id="chiefIdDisplay"></p>
            </div>
        </div>
        <div class="header-center"><h1>Request Rations</h1></div>
        <a href="chief_dashboard.html" class="back-dashboard-btn">‚Üê Dashboard</a>
    </div>

    <div class="main-container">
        <div class="request-container">
            <h2 class="section-title">Create New Ration Request</h2>
            <div class="form-group"><label for="preparationFor">This request is for:</label><select id="preparationFor"><option value="General Stock" selected>General Stock</option><option value="Breakfast">Breakfast</option><option value="Lunch">Lunch</option><option value="Snacks">Snacks</option><option value="Dinner">Dinner</option><option value="Special Event">Special Event</option></select></div>
            <div class="item-selector-grid">
                <div class="form-group"><label>1. Select a Category</label><ul id="categoryList" class="category-list"></ul></div>
                <div class="form-group"><label for="itemSearch">2. Search or Click to Add Item</label><input type="text" id="itemSearch" placeholder="Search selected category..."><div id="itemList"></div></div>
            </div>
            <label>3. Review Your Request List</label>
            <table class="request-table">
                <thead><tr><th>Item</th><th>Available</th><th>Request Quantity</th><th>Unit</th><th>Action</th></tr></thead>
                <tbody id="requestTableBody"></tbody>
            </table>
            <div class="actions-container">
                <button id="submitRequestBtn" class="submit-btn" disabled>Submit Request</button>
            </div>
            <div id="pdfActionContainer"></div>
            <p id="formMessage" class="message"></p>
        </div>
        <div class="history-container">
            <h2 class="section-title">My Request History</h2>
            <table class="request-table">
                <thead><tr><th>Date & Time</th><th>For</th><th>Status</th><th>Items</th><th>Action</th></tr></thead>
                <tbody id="historyTableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
          
            // --- All your variables and functions go here ---
            let availableItems = {}; let requestCart = []; let currentCategory = '';
            const chiefId = localStorage.getItem('chiefId');
            const chiefName = localStorage.getItem('chiefName');
            const hostelName = localStorage.getItem('selectedHostelName') || 'BCM Hostel';
            const hostelCode = localStorage.getItem('selectedHostelCode') || 'N/A';
            const chiefNameEl = document.getElementById('chiefName');
            const chiefIdDisplayEl = document.getElementById('chiefIdDisplay');
            const profilePicEl = document.getElementById('profilePic');
            const itemSearch = document.getElementById('itemSearch');
            const itemList = document.getElementById('itemList');
            const categoryList = document.getElementById('categoryList');
            const requestTableBody = document.getElementById('requestTableBody');
            const historyTableBody = document.getElementById('historyTableBody');
            const submitRequestBtn = document.getElementById('submitRequestBtn');
            const pdfActionContainer = document.getElementById('pdfActionContainer');
            const preparationForSelect = document.getElementById('preparationFor');
            const formMessage = document.getElementById('formMessage');

            if (!chiefId) { window.location.href = '/chief-login.html'; return; }
        document.getElementById('chiefName').textContent = chiefName || 'Chief';
            
            async function fetchInitialData() {
                try {
                    const [profileRes, itemsRes, historyRes] = await Promise.all([
                        fetch(`/api/chief-auth/profile/${chiefId}`),
                        fetch('/api/chief/available-rations'),
                        fetch(`/api/chief/my-requests/${chiefId}`)
                    ]);
                    const profileData = await profileRes.json();
                    if(profileData.success) {
                        chiefIdDisplayEl.textContent = `ID: ${profileData.chief.loginId}`;
                        profilePicEl.src = profileData.chief.photo ? `/uploads/${profileData.chief.photo}` : 'https://placehold.co/100x100';
                    }
                    const itemsData = await itemsRes.json();
                    if(itemsData.success) { availableItems = itemsData.items; renderCategories(); }
                    const historyData = await historyRes.json();
                    if(historyData.success) renderHistory(historyData.requests);
                } catch (error) { console.error("Failed to load initial data:", error); }
            }

            function renderCategories() {
                categoryList.innerHTML = '';
                const categories = Object.keys(availableItems);
                if(categories.length > 0) {
                    categories.forEach(category => {
                        const li = document.createElement('li');
                        li.textContent = category;
                        li.dataset.category = category;
                        categoryList.appendChild(li);
                    });
                    categoryList.firstChild.click();
                }
            }

            function renderItems(category, searchTerm = '') {
                itemList.innerHTML = '';
                let itemsToRender = availableItems[category] || [];
                if (searchTerm) {
                    itemsToRender = itemsToRender.filter(item => item.itemName.toLowerCase().includes(searchTerm));
                }
                itemsToRender.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'item-card';
                    card.innerHTML = `<img src="/${item.itemImage}" class="item-photo" onerror="this.style.display='none'"><span>${item.itemName}</span>`;
                    card.addEventListener('click', () => addItemToCart(item));
                    itemList.appendChild(card);
                });
            }

            function renderCart() {
                requestTableBody.innerHTML = '';
                requestCart.forEach((cartItem, index) => {
                    const row = document.createElement('tr');
                    const availableStock = cartItem.currentStock;
                    row.innerHTML = `<td>${cartItem.itemName}</td><td>${availableStock} ${cartItem.unit}</td><td><input type="number" value="${cartItem.quantity}" min="1" max="${availableStock}" data-index="${index}" class="quantity-input"></td><td>${cartItem.unit}</td><td><button class="remove-btn" data-index="${index}"><i class="fas fa-trash"></i></button></td>`;
                    requestTableBody.appendChild(row);
                });
                updateSubmitButton();
            }

            function renderHistory(requests) {
                historyTableBody.innerHTML = '';
                requests.forEach(req => {
                    const row = document.createElement('tr');
                    const itemsList = req.items.map(i => i.item ? `${i.item.itemName} (${i.quantity} ${i.unit})` : 'Item not found').join(', ');
                    row.innerHTML = `<td>${new Date(req.createdAt).toLocaleString('en-GB')}</td><td>${req.preparationFor}</td><td><span class="status-badge status-${req.status}">${req.status}</span></td><td>${itemsList}</td><td><button class="pdf-btn" data-reqid="${req._id}" style="font-size:0.8em; padding: 5px 10px;">PDF</button></td>`;
                    historyTableBody.appendChild(row);
                });
            }

            function addItemToCart(item) {
                if (!requestCart.some(cartItem => cartItem.item === item._id)) {
                    requestCart.push({ item: item._id, itemName: item.itemName, quantity: 1, unit: item.unit, currentStock: item.currentStock });
                    renderCart();
                }
                itemSearch.value = '';
                renderItems(currentCategory);
            }

            function updateSubmitButton() {
                submitRequestBtn.disabled = requestCart.length === 0;
            }

            
        // --- THIS IS THE NEW, SERVER-SIDE PDF FUNCTION ---
             async function generatePDF(requestData) {
    try {
        // This part is correct
        const itemsForPdf = requestData.items.map(i => ({
            itemName: i.item ? i.item.itemName : 'N/A', 
            quantity: i.quantity, 
            unit: i.unit
        }));

        // ===================================================================
        // --- START OF CORRECTED LOGIC ---
        // ===================================================================

        // 1. Get the chief's unique user ID from the request object itself
        const chiefUserId = requestData.requestedBy;
        if (!chiefUserId) {
            throw new Error('Chief user ID is missing from the request data.');
        }

        // 2. Fetch the chief's full profile to get their name and readable ID
        const chiefProfileResponse = await fetch(`/api/chief-auth/profile/${chiefUserId}`);
        if (!chiefProfileResponse.ok) {
            throw new Error('Could not fetch the chief profile information.');
        }
        const profileData = await chiefProfileResponse.json();

        // 3. Extract the details needed for the PDF from the fetched profile
        //    (Assuming your profile API returns 'loginId' and 'name')
        const chiefName = profileData.success ? profileData.chief.name : 'N/A';
        const chiefLoginId = profileData.success ? profileData.chief.loginId : 'undefined';

        // ===================================================================
        // --- END OF CORRECTED LOGIC ---
        // ===================================================================

        // 4. Send the complete, correct data to the backend to generate the PDF
        const response = await fetch('/api/chief/generate-pdf', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                items: itemsForPdf,
                chiefName: chiefName,                   // Use the fetched name
                chiefId: chiefLoginId,                  // Use the fetched login ID
                hostelName: requestData.hostelName,     // Get hostelName from requestData
                hostelCode: requestData.hostelCode,     // Get hostelCode from requestData
                preparationFor: requestData.preparationFor,
                requestDate: requestData.createdAt
            })
        });

        if (!response.ok) { throw new Error('Server failed to generate PDF.'); }
        
        // This download logic is correct and remains unchanged
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `Ration_Request_${new Date(requestData.createdAt).toISOString().split('T')[0]}.pdf`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();

    } catch (error) {
        console.error("Error downloading PDF:", error);
        alert("Failed to download PDF. Please check the console.");
    }
}  
            
            categoryList.addEventListener('click', (e) => { if (e.target.tagName === 'LI') { document.querySelectorAll('.category-list li').forEach(li => li.classList.remove('active')); e.target.classList.add('active'); currentCategory = e.target.dataset.category; itemSearch.value = ''; renderItems(currentCategory); } });
            itemSearch.addEventListener('input', () => { renderItems(currentCategory, itemSearch.value.toLowerCase()); });
            requestTableBody.addEventListener('input', (e) => { if(e.target.classList.contains('quantity-input')) { const index = e.target.dataset.index; let value = parseInt(e.target.value, 10); const max = parseInt(e.target.max, 10); if (value > max) { alert(`Cannot request more than the available stock of ${max}.`); e.target.value = max; value = max; } requestCart[index].quantity = value; } });
            requestTableBody.addEventListener('click', (e) => { const removeBtn = e.target.closest('.remove-btn'); if(removeBtn) { requestCart.splice(removeBtn.dataset.index, 1); renderCart(); } });
            
            // --- THIS IS THE MISSING SUBMIT HANDLER ---
            submitRequestBtn.addEventListener('click', async () => { 
                pdfActionContainer.innerHTML = '';
                formMessage.textContent = 'Submitting...';
                try {
                    const response = await fetch('/api/chief/request-ration', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            items: requestCart.map(({ item, quantity, unit }) => ({ item, quantity, unit })),
                            chiefId: chiefId,
                            hostelName: hostelName,
                            hostelCode: hostelCode,
                            preparationFor: preparationForSelect.value
                        })
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.message);
                    formMessage.textContent = result.message; 
                    formMessage.style.color = 'green';
                    
                    const newPdfBtn = document.createElement('button');
                    newPdfBtn.className = 'pdf-btn';
                    newPdfBtn.textContent = 'Download Submitted Request as PDF';
                    newPdfBtn.onclick = () => generatePDF(result.request);
                    pdfActionContainer.appendChild(newPdfBtn);
                    
                    requestCart = []; 
                    renderCart(); 
                    fetchInitialData();
                } catch (error) { 
                    formMessage.textContent = `Error: ${error.message}`; 
                    formMessage.style.color = 'red'; 
                }
            });
            
          // --- THIS IS THE CORRECTED HISTORY PDF HANDLER ---
         // --- THIS IS THE CORRECTED HISTORY HANDLER ---
            historyTableBody.addEventListener('click', async (e) => {
                if(e.target.classList.contains('pdf-btn')) {
                    const reqId = e.target.dataset.reqid;
                    try {
                        const historyResponse = await fetch(`/api/chief/my-requests/${chiefId}`);
                        const historyData = await historyResponse.json();
                        const request = historyData.requests.find(r => r._id === reqId);
                        if (request) {
                            generatePDF(request);
                        }
                    } catch (error) {
                        alert("Could not prepare data for the PDF.");
                    }
                }
            });
            
            fetchInitialData();
        });
    </script>
</body>
</html>