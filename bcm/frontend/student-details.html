<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Details</title>
    <meta http-equiv="Content-Security-Policy" content="connect-src 'self' https://generativelanguage.googleapis.com;">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f4f7f6;
            margin: 0;
            padding: 2rem;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: #fff;
            padding: 2.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 2rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 1.5rem;
        }
        .header h2 {
            color: #333;
            margin-bottom: 0.5rem;
        }
        .main-content {
            display: flex;
            gap: 2rem;
        }
        .details-column {
            flex: 2;
        }
        .photo-column {
            flex: 1;
            text-align: center;
        }
        .student-photo {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #eee;
        }
        .detail-section {
            margin-bottom: 2rem;
        }
        .detail-section h4 {
            color: #007bff;
            border-bottom: 2px solid #007bff;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .detail-item strong {
            color: #555;
        }
        .document-list a {
            display: block;
            padding: 0.75rem;
            background-color: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 0.5rem;
            text-decoration: none;
            color: #333;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .document-list a:hover {
            background-color: #e9ecef;
        }
        .actions {
            text-align: center;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #eee;
        }
        .download-btn {
            padding: 0.8rem 2rem;
            border: none;
            border-radius: 25px;
            background-color: #28a745;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .download-btn:hover {
            background-color: #218838;
        }
        #loadingMessage {
            text-align: center;
            font-size: 1.2rem;
            color: #555;
        }

        .summary-btn {
    padding: 0.8rem 2rem;
    border: none;
    border-radius: 25px;
    background-color: #6a11cb; /* Gemini Purple */
    color: white;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.2s;
}
.summary-btn:hover {
    background-color: #2575fc; /* Gemini Blue */
}
.summary-content {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
    border-left: 4px solid #6a11cb;
    line-height: 1.6;
    color: #333;
}
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

    <div class="container" id="studentDetailsContainer" style="display: none;">
        <div class="header">
            <h2 id="studentName"></h2>
            <p id="studentSspId"></p>
        </div>

        <div class="main-content">
            <div class="details-column">
                <div class="detail-section" id="personalInfo"><h4>Personal Information</h4></div>
                <div class="detail-section" id="parentInfo"><h4>Parent Information</h4></div>
            </div>
            <div class="photo-column">
                <img id="studentPhoto" src="" alt="Student Photo" class="student-photo">
            </div>
        </div>

    
        
        <div class="detail-section" id="professionalInfo"><h4>Professional Information</h4></div>
        <div class="detail-section" id="academicInfo"><h4>Academic Information</h4></div>
        <div class="detail-section" id="documentsInfo"><h4>Uploaded Documents</h4><div class="document-list" id="documentList"></div></div>

       <div class="actions">
    <!-- ADD THIS NEW BUTTON -->
    <button class="summary-btn" id="generateSummaryBtn">✨ Smart Summary</button>
    <button class="download-btn" id="downloadPdfBtn">Download as PDF</button>
     </div>


         <!-- ADD THIS NEW CONTAINER -->
     <div class="detail-section" id="summarySection" style="display: none;">
     <h4>✨ AI-Generated Summary</h4>
      <div id="summaryContent" class="summary-content"></div>
      </div>
      
    </div>

    <p id="loadingMessage">Loading student details...</p>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const studentId = localStorage.getItem('viewStudentId');
            const loadingMessage = document.getElementById('loadingMessage');
            const container = document.getElementById('studentDetailsContainer');

            if (!studentId) {
                loadingMessage.textContent = 'Error: No student selected. Please go back to the manage page.';
                loadingMessage.style.color = 'red';
                return;
            }

            try {
                // We will create this backend route in the next step
                const response = await fetch(`/api/students/details/${studentId}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch student details.');
                }
                const student = await response.json();

                // --- Populate Header ---
                document.getElementById('studentName').textContent = student.name;
                document.getElementById('studentSspId').textContent = `SSP ID: ${student.sspId}`;
                const photoSrc = student.photo ? `/${student.photo}` : 'https://placehold.co/150x150/EFEFEF/AAAAAA&text=No+Photo';
                document.getElementById('studentPhoto').src = photoSrc;

                // --- Helper function to add detail items ---
                const addDetail = (sectionId, label, value) => {
                    if (value) {
                        const section = document.getElementById(sectionId);
                        section.innerHTML += `<div class="detail-item"><strong>${label}:</strong> <span>${value}</span></div>`;
                    }
                };

                // --- Populate Sections ---
                addDetail('personalInfo', 'Date of Birth', new Date(student.dob).toLocaleDateString());
                addDetail('personalInfo', 'Phone', student.phone);
                addDetail('personalInfo', 'Email', student.email);
                addDetail('personalInfo', 'Address', student.address);

                addDetail('parentInfo', "Father's Name", student.fatherName);
                addDetail('parentInfo', "Mother's Name", student.motherName);
                addDetail('parentInfo', 'Parent Phone', student.parentPhone);
                addDetail('parentInfo', 'Parent Email', student.parentEmail);
                addDetail('parentInfo', 'Parent Address', student.parentAddress);

                addDetail('professionalInfo', 'Aadhar Number', student.aadharNumber);
                addDetail('professionalInfo', 'Caste Certificate No.', student.casteNumber);
                addDetail('professionalInfo', 'Income Certificate No.', student.incomeNumber);
                addDetail('professionalInfo', 'Bank Account No.', student.accountNumber);
                addDetail('professionalInfo', 'IFSC Code', student.ifsc);

                addDetail('academicInfo', '10th Marks', student.tenthMarks);
                addDetail('academicInfo', 'Studied After 10th', student.studyAfter10th);
                
                if (student.pucDetails && student.pucDetails.pucMarks) addDetail('academicInfo', 'PUC Marks', student.pucDetails.pucMarks);
                if (student.diplomaDetails && student.diplomaDetails.diplomaMarks) addDetail('academicInfo', 'Diploma Marks', student.diplomaDetails.diplomaMarks);
                if (student.itiDetails && student.itiDetails.itiMarks) addDetail('academicInfo', 'ITI Marks', student.itiDetails.itiMarks);
                
                if (student.currentStudy && student.currentStudy.level) {
                addDetail('academicInfo', 'Current Level', student.currentStudy.level);
                 addDetail('academicInfo', 'Degree', student.currentStudy.degree);
                 addDetail('academicInfo', 'College', student.currentStudy.college);
                addDetail('academicInfo', 'Current Year', student.currentStudy.currentYear);

               addDetail('academicInfo', 'Current Semester', student.currentStudy.currentSemester);

              // Add previous semester/year marks
              if (student.currentStudy.previousMarks && student.currentStudy.previousMarks.length > 0) {
             student.currentStudy.previousMarks.forEach(mark => {
             addDetail('academicInfo', `Previous ${mark.type} ${mark.number} Marks`, mark.marks);
             });
             }
             }

                // --- List Documents ---
                const documentList = document.getElementById('documentList');
                const docFields = {
                    'Aadhar Card': student.aadharCard,
                    'Caste Certificate': student.casteCertificate,
                    'Income Certificate': student.incomeCertificate,
                    'Bank Passbook': student.passbook,
                    '10th Marks Card': student.tenthMarksCard,
                    'PUC Marks Card': student.pucDetails ? student.pucDetails.pucMarksCard : null,
                    'Diploma Marks Card': student.diplomaDetails ? student.diplomaDetails.diplomaMarksCard : null,
                    'ITI Marks Card': student.itiDetails ? student.itiDetails.itiMarksCard : null,
                    'UG Marks Card (for PG)': student.currentStudy ? student.currentStudy.pgLastUgMarksCard : null
                };

                for (const [label, path] of Object.entries(docFields)) {
                    if (path) {
                        documentList.innerHTML += `<a href="/${path}" target="_blank">${label}</a>`;
                    }
                }

                // --- Show the content ---
                loadingMessage.style.display = 'none';
                container.style.display = 'block';

            } catch (error) {
                console.error('Error fetching student details:', error);
                loadingMessage.textContent = 'Could not load student details. Please try again.';
                loadingMessage.style.color = 'red';
            }
        });





// ===================================================================
// ORIGINAL PDF DOWNLOAD LOGIC (Text and Photo Only)
// ===================================================================
downloadPdfBtn.addEventListener('click', async () => {
    const studentId = localStorage.getItem('viewStudentId');
    if (!studentId) return;

    downloadPdfBtn.textContent = 'Generating...';
    downloadPdfBtn.disabled = true;

    try {
        const response = await fetch(`/api/students/details/${studentId}`);
        const student = await response.json();

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let yPosition = 0;
        const pageHeight = doc.internal.pageSize.height;
        const pageWidth = doc.internal.pageSize.width;
        const margin = 20;

        // --- Professional Styling and Layout Helpers ---
        const addHeader = (title) => {
            doc.setFontSize(22);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(40, 52, 71); // Dark Blue
            doc.text(title, pageWidth / 2, 22, { align: 'center' });
            doc.setDrawColor(221, 221, 221); // Light gray line
            doc.line(margin, 30, pageWidth - margin, 30);
            yPosition = 45;
        };

        const addFooter = () => {
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(10);
                doc.setTextColor(150);
                doc.text(`Page ${i} of ${pageCount}`, pageWidth - margin, pageHeight - 10, { align: 'right' });
                doc.text(`Student: ${student.name}`, margin, pageHeight - 10);
            }
        };

        const addSectionTitle = (title) => {
            if (yPosition > pageHeight - 40) { doc.addPage(); yPosition = 30; }
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(60, 110, 180); // Medium Blue
            doc.text(title, margin, yPosition);
            yPosition += 10;
        };

        // --- MODIFIED HELPER FUNCTION ---
        const addText = (label, value) => {
            if (value != null && value !== '') {
                if (yPosition > pageHeight - 20) { doc.addPage(); yPosition = 30; }
                doc.setFontSize(11);
                
                // Style for the label (less prominent)
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(80);
                doc.text(`${label}:`, margin + 5, yPosition);
                
                // Style for the value (bolder and darker)
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 0, 0);
                const textLines = doc.splitTextToSize(String(value), 100);
                doc.text(textLines, 85, yPosition);
                yPosition += (textLines.length * 6) + 4;
            }
        };

        // --- PAGE 1: MAIN DETAILS & PHOTO ---
        addHeader('Student Registration Details');

        if (student.photo) {
            const photoResponse = await fetch(`/api/students/image/${studentId}`);
            const photoData = await photoResponse.json();
            doc.addImage(photoData.data, 'JPEG', 140, 40, 50, 50);
        }

        addSectionTitle('Personal Information');
        addText('Name', student.name);
        addText('SSP ID', student.sspId);
        addText('Date of Birth', new Date(student.dob).toLocaleDateString());
        addText('Phone', student.phone);
        addText('Email', student.email);
        addText('Address', student.address);
        yPosition += 5;

        addSectionTitle('Parent Information');
        addText("Father's Name", student.fatherName);
        addText("Mother's Name", student.motherName);
        addText('Parent Phone', student.parentPhone);
        addText('Parent Email', student.parentEmail);
        addText('Parent Address', student.parentAddress);
        yPosition += 5;
        
        // --- THIS LINE WAS REMOVED TO FIX THE BLANK SPACE ---
        // doc.addPage(); 
        // yPosition = 30;

        addSectionTitle('Professional Information');
        addText('Aadhar Number', student.aadharNumber);
        addText('Caste Cert. No.', student.casteNumber);
        addText('Income Cert. No.', student.incomeNumber);
        addText('Bank Account No.', student.accountNumber);
        addText('IFSC Code', student.ifsc);
        yPosition += 5;

        addSectionTitle('Academic Information');
        addText('10th Marks', student.tenthMarks);
        addText('Studied After 10th', student.studyAfter10th);
        
        if (student.pucDetails) addText('PUC Marks', student.pucDetails.pucMarks);
        if (student.diplomaDetails) addText('Diploma Marks', student.diplomaDetails.diplomaMarks);
        if (student.itiDetails) addText('ITI Marks', student.itiDetails.itiMarks);
        
        if (student.currentStudy && student.currentStudy.level) {
            addText('Current Level', student.currentStudy.level);
            addText('Degree', student.currentStudy.degree);
            addText('College', student.currentStudy.college);
            addText('Current Year', student.currentStudy.currentYear);
            addText('Current Semester', student.currentStudy.currentSemester);
            
            if (student.currentStudy.previousMarks && student.currentStudy.previousMarks.length > 0) {
                 yPosition += 3;
                 student.currentStudy.previousMarks.forEach(mark => {
                     addText(`Previous ${mark.type} ${mark.number} Marks`, mark.marks);
                 });
            }
        }
        yPosition += 5;

        addSectionTitle('Uploaded Documents');
        const docFields = {
            'Photo': student.photo, 'Aadhar Card': student.aadharCard, 'Caste Certificate': student.casteCertificate,
            'Income Certificate': student.incomeCertificate, 'Bank Passbook': student.passbook, '10th Marks Card': student.tenthMarksCard,
            'PUC Marks Card': student.pucDetails ? student.pucDetails.pucMarksCard : null,
            'Diploma Marks Card': student.diplomaDetails ? student.diplomaDetails.diplomaMarksCard : null,
            'ITI Marks Card': student.itiDetails ? student.itiDetails.itiMarksCard : null,
            'UG Marks Card (for PG)': student.currentStudy ? student.currentStudy.pgLastUgMarksCard : null
        };

        for (const [label, path] of Object.entries(docFields)) {
            if (path) addText(label, path.split('/').pop());
        }
        
        if (student.currentStudy && student.currentStudy.previousMarks) {
            student.currentStudy.previousMarks.forEach(mark => {
                if (mark.marksCard) {
                    const label = `Previous ${mark.type} ${mark.number} Marks Card`;
                    addText(label, mark.marksCard.split('/').pop());
                }
            });
        }

        // --- Add Footer and Save ---
        addFooter();
        doc.save(`${student.name}_${student.sspId}_details.pdf`);

    } catch (error) {
        console.error('PDF Generation Error:', error);
        alert('Could not generate PDF. Please try again.');
    } finally {
        downloadPdfBtn.textContent = 'Download as PDF';
        downloadPdfBtn.disabled = false;
    }
});












// ===================================================================
// NEW: GEMINI API - SMART SUMMARY LOGIC
// ===================================================================
const generateSummaryBtn = document.getElementById('generateSummaryBtn');
const summarySection = document.getElementById('summarySection');
const summaryContent = document.getElementById('summaryContent');

generateSummaryBtn.addEventListener('click', async () => {
    const studentId = localStorage.getItem('viewStudentId');
    if (!studentId) return;

    generateSummaryBtn.textContent = '✨ Thinking...';
    generateSummaryBtn.disabled = true;
    summarySection.style.display = 'none';

    try {
        // Fetch the full student data
        const response = await fetch(`/api/students/details/${studentId}`);
        const student = await response.json();

        // --- 1. Construct the Prompt ---
        // Create a clear, detailed prompt for the Gemini API
        let prompt = `Summarize the following student's profile in a friendly, professional paragraph. Highlight their academic standing and any key details. Here is the data:\n\n`;
        prompt += `Name: ${student.name}\n`;
        prompt += `Email: ${student.email}\n`;
        prompt += `Academic Path: Started with ${student.studyAfter10th} after 10th grade.\n`;
        if (student.currentStudy && student.currentStudy.level) {
            prompt += `Currently a ${student.currentStudy.level} student pursuing a ${student.currentStudy.degree} at ${student.currentStudy.college}.\n`;
            prompt += `They are in Year ${student.currentStudy.currentYear}, Semester ${student.currentStudy.currentSemester}.\n`;
        }
        prompt += `Parent Contact: ${student.fatherName} at ${student.parentPhone}.\n`;
        prompt += `Generate a concise summary.`;

        // --- 2. Call the Gemini API ---
        let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
        const payload = { contents: chatHistory };
        const apiKey = "AIzaSyDo_fxYFf708apQO7NHLMQ_xhQiZIn5k4k"; // API key is handled by the environment
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;

        const apiResponse = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!apiResponse.ok) {
            throw new Error('Failed to get a response from the Gemini API.');
        }

        const result = await apiResponse.json();
        
        if (result.candidates && result.candidates.length > 0) {
            const summaryText = result.candidates[0].content.parts[0].text;
            
            // --- 3. Display the Result ---
            summaryContent.textContent = summaryText;
            summarySection.style.display = 'block';
        } else {
            throw new Error('No summary was generated.');
        }

    } catch (error) {
        console.error('Gemini Summary Error:', error);
        alert('Could not generate the summary. Please try again.');
    } finally {
        generateSummaryBtn.textContent = '✨ Smart Summary';
        generateSummaryBtn.disabled = false;
    }
});


    </script>

</body>
</html>
